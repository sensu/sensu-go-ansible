---
- name: Converge
  hosts: backends
  vars:
    etcd_cert_file: files/etcd-client.crt
    etcd_key_file: files/etcd-client.key
    etcd_trusted_ca_file: files/client-ca.crt
    etcd_peer_cert_file: files/etcd-peer.crt
    etcd_peer_key_file: files/etcd-peer.key
    etcd_peer_trusted_ca_file: files/etcd-peer-ca.crt
    api_cert_file: files/sensu-api.crt
    api_key_file: files/sensu-api.key
    api_trusted_ca_file: files/sensu-api-ca.crt
    dashboard_cert_file: files/sensu-dashboard.crt
    dashboard_key_file: files/sensu-dashboard.key
  roles:
    - sensu.sensu_go.backend

- name: Verify
  hosts: backends
  tags:
    - configure_backend
  tasks:
    - name: The public keys must exist
      stat:
        path: "{{ item }}"
      register: result
      with_items:
        - /etc/sensu/etcd-client.crt
        - /etc/sensu/etcd-client-ca.crt
        - /etc/sensu/etcd-peer.crt
        - /etc/sensu/etcd-peer-ca.crt
        - /etc/sensu/api.crt
        - /etc/sensu/api-ca.crt
        - /etc/sensu/dashboard.crt

    - assert:
        that:
          - "{{ item.stat.exists }}"
          - "{{ item.stat.pw_name == 'sensu' }}"
          - "{{ item.stat.gr_name == 'sensu' }}"
          - "{{ item.stat.mode == '0644' }}"
      with_items: "{{ result.results }}"

    - name: The private keys must exist and be protected
      stat:
        path: "{{ item }}"
      register: result
      with_items:
        - /etc/sensu/etcd-client.key
        - /etc/sensu/etcd-peer.key
        - /etc/sensu/api.key
        - /etc/sensu/dashboard.key

    - assert:
        that:
          - "{{ item.stat.exists }}"
          - "{{ item.stat.pw_name == 'sensu' }}"
          - "{{ item.stat.gr_name == 'sensu' }}"
          - "{{ item.stat.mode == '0400' }}"
      with_items: "{{ result.results }}"

    - name: Confirm secured configuration settings
      lineinfile:
        path: &backend_yml /etc/sensu/backend.yml
        line: '{{ item }}'
      with_items:
        - 'state-dir: "/var/lib/sensu/sensu-backend"'
        - 'etcd-listen-client-urls: "https://localhost:2379"'
        - 'etcd-listen-peer-urls: "https://localhost:2380"'
        - 'etcd-initial-advertise-peer-urls: "https://localhost:2380"'
        - 'etcd-initial-cluster: "default=https://localhost:2380"'
        - 'etcd-cert-file: "/etc/sensu/etcd-client.crt"'
        - 'etcd-key-file: "/etc/sensu/etcd-client.key"'
        - 'etcd-trusted-ca-file: "/etc/sensu/etcd-client-ca.crt"'
        - 'etcd-client-cert-auth: true'
        - 'etcd-peer-cert-file: "/etc/sensu/etcd-peer.crt"'
        - 'etcd-peer-key-file: "/etc/sensu/etcd-peer.key"'
        - 'etcd-peer-client-cert-auth: true'
        - 'etcd-peer-trusted-ca-file: "/etc/sensu/etcd-peer-ca.crt"'
        - 'cert-file: "/etc/sensu/api.crt"'
        - 'key-file: "/etc/sensu/api.key"'
        - 'trusted-ca-file: "/etc/sensu/api-ca.crt"'
        - 'insecure-skip-tls-verify: false'
        - 'api-url: "https://localhost:8080"'
        - 'dashboard-cert-file: "/etc/sensu/dashboard.crt"'
        - 'dashboard-key-file: "/etc/sensu/dashboard.key"'
      register: result

    - assert:
        that:
          - result is not changed

- name: Default configuration
  hosts: backends
  roles:
    - sensu.sensu_go.backend

- name: Verify default configuration
  hosts: backends
  tags:
    - configure_backend
  tasks:
    - name: Confirm that none of secured configuration settings leak in
      lineinfile:
        path: *backend_yml
        regexp: '{{ item }}'
        state: absent
      with_items:
        - '^etcd-listen-client-urls:'
        - '^etcd-listen-peer-urls:'
        - '^etcd-initial-advertise-peer-urls:'
        - '^etcd-initial-cluster:'
        - '^etcd-cert-file:'
        - '^etcd-key-file:'
        - '^etcd-trusted-ca-file:'
        - '^etcd-client-cert-auth:'
        - '^etcd-peer-cert-file:'
        - '^etcd-peer-key-file:'
        - '^etcd-peer-client-cert-auth:'
        - '^etcd-peer-trusted-ca-file:'
        - '^cert-file:'
        - '^key-file:'
        - '^trusted-ca-file:'
        - '^insecure-skip-tls-verify:'
        - '^api-url:'
        - '^dashboard-cert-file:'
        - '^dashboard-key-file:'
      register: result

    - assert:
        that:
          - result is not changed

- name: Configure an overriding of managed vars
  hosts: backends
  vars:
    etcd_cert_file: files/etcd-client.crt
    etcd_key_file: files/etcd-client.key
    etcd_trusted_ca_file: files/client-ca.crt
    etcd_peer_cert_file: files/etcd-peer.crt
    etcd_peer_key_file: files/etcd-peer.key
    etcd_peer_trusted_ca_file: files/etcd-peer-ca.crt
    api_cert_file: files/sensu-api.crt
    api_key_file: files/sensu-api.key
    api_trusted_ca_file: files/sensu-api-ca.crt
    dashboard_cert_file: files/sensu-dashboard.crt
    dashboard_key_file: files/sensu-dashboard.key
    backend_config:
      debug: true
      log-level: debug
      state-dir: /tmp/different-state
      etcd-listen-client-urls: "https://127.0.0.1:2379"
      etcd-listen-peer-urls: "https://127.0.0.1:2380"
      etcd-initial-advertise-peer-urls: "https://127.0.0.1:2380"
      etcd-initial-cluster: "default=https://127.0.0.1:2380"
      etcd-cert-file: "/etc/sensu/../sensu/etcd-client.crt"
      etcd-key-file: "/etc/sensu/../sensu/etcd-client.key"
      etcd-trusted-ca-file: "/etc/sensu/../sensu/etcd-client-ca.crt"
      etcd-client-cert-auth: false
      etcd-peer-cert-file: "/etc/sensu/../sensu/etcd-peer.crt"
      etcd-peer-key-file: "/etc/sensu/../sensu/etcd-peer.key"
      etcd-peer-client-cert-auth: false
      etcd-peer-trusted-ca-file: "/etc/sensu/../sensu/etcd-peer-ca.crt"
      cert-file: "/etc/sensu/../sensu/api.crt"
      key-file: "/etc/sensu/../sensu/api.key"
      trusted-ca-file: "/etc/sensu/../sensu/api-ca.crt"
      insecure-skip-tls-verify: true
      api-url: "https://127.0.0.1:8080"
      dashboard-cert-file: /etc/sensu/../sensu/dashboard.crt
      dashboard-key-file: /etc/sensu/../sensu/dashboard.key

  roles:
    - sensu.sensu_go.backend

- name: Verify the overriding of managed vars
  hosts: backends
  tags:
    - configure_backend
  tasks:
    - name: Confirm overriding of managed vars configuration settings
      lineinfile:
        path: *backend_yml
        line: '{{ item }}'
      with_items:
        - 'state-dir: /tmp/different-state'
        - 'log-level: debug'
        - 'etcd-listen-client-urls: https://127.0.0.1:2379'
        - 'etcd-listen-peer-urls: https://127.0.0.1:2380'
        - 'etcd-initial-advertise-peer-urls: https://127.0.0.1:2380'
        - 'etcd-initial-cluster: default=https://127.0.0.1:2380'
        - 'etcd-cert-file: /etc/sensu/../sensu/etcd-client.crt'
        - 'etcd-key-file: /etc/sensu/../sensu/etcd-client.key'
        - 'etcd-trusted-ca-file: /etc/sensu/../sensu/etcd-client-ca.crt'
        - 'etcd-client-cert-auth: false'
        - 'etcd-peer-cert-file: /etc/sensu/../sensu/etcd-peer.crt'
        - 'etcd-peer-key-file: /etc/sensu/../sensu/etcd-peer.key'
        - 'etcd-peer-client-cert-auth: false'
        - 'etcd-peer-trusted-ca-file: /etc/sensu/../sensu/etcd-peer-ca.crt'
        - 'cert-file: /etc/sensu/../sensu/api.crt'
        - 'key-file: /etc/sensu/../sensu/api.key'
        - 'trusted-ca-file: /etc/sensu/../sensu/api-ca.crt'
        - 'insecure-skip-tls-verify: true'
        - 'api-url: https://127.0.0.1:8080'
        - 'dashboard-cert-file: /etc/sensu/../sensu/dashboard.crt'
        - 'dashboard-key-file: /etc/sensu/../sensu/dashboard.key'
      register: result

    - assert:
        that:
          - result is not changed
