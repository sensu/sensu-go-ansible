---
- name: Converge
  collections:
    - sensu.sensu_go
  hosts: all
  gather_facts: no
  tasks:
    - name: Create an asset
      asset:
        auth:
          url: http://localhost:8080
        name: asset
        url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
        sha512: 518e7c17cf670393045bff4af318e1d35955bfde166e9ceec2b469109252f79043ed133241c4dc96501b6636a1ec5e008ea9ce055d1609865635d4f004d7187b
        filters:
          - "entity.system.os == 'linux'"
          - "entity.system.arch == 'amd64'"
          - "entity.system.platform == 'rhel'"
        headers:
          Sensu-Blivet: foo
        annotations:
          sensio.io.bonsai.url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
          sensio.io.bonsai.tier: Community
          sensio.io.bonsai.version: 4.0.0
          sensio.io.bonsai.tags: ruby-runtime-2.4.4
      register: result

    - assert:
        that:
          - result is changed
          - result.object.url == 'https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz'
          - result.object.sha512 == '518e7c17cf670393045bff4af318e1d35955bfde166e9ceec2b469109252f79043ed133241c4dc96501b6636a1ec5e008ea9ce055d1609865635d4f004d7187b'
          - result.object.headers['Sensu-Blivet'] == "foo"
          - result.object.filters == ["entity.system.os == 'linux'", "entity.system.arch == 'amd64'", "entity.system.platform == 'rhel'"]
          - result.object.metadata.name == 'asset'

    - name: Test asset creation idempotence
      asset:
        auth:
          url: http://localhost:8080
        name: asset
        url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
        sha512: 518e7c17cf670393045bff4af318e1d35955bfde166e9ceec2b469109252f79043ed133241c4dc96501b6636a1ec5e008ea9ce055d1609865635d4f004d7187b
        filters:
          - "entity.system.os == 'linux'"
          - "entity.system.arch == 'amd64'"
          - "entity.system.platform == 'rhel'"
        headers:
          Sensu-Blivet: foo
        annotations:
          sensio.io.bonsai.url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
          sensio.io.bonsai.tier: Community
          sensio.io.bonsai.version: 4.0.0
          sensio.io.bonsai.tags: ruby-runtime-2.4.4
      register: result

    - assert:
        that: result is not changed

    - name: Modify asset
      asset:
        auth:
          url: http://localhost:8080
        name: asset
        url: https://assets.bonsai.sensu.io/73a6f8b6f56672630d83ec21676f9a6251094475/sensu-plugins-disk-checks_5.0.0_centos_linux_amd64.tar.gz
        sha512: 0ce9d52b270b77f4cab754e55732ae002228201d0bd01a89b954a0655b88c1ee6546e2f82cfd1eec04689af90ad940cde128e8867912d9e415f4a58d7fdcdadf
        annotations:
          sensio.io.bonsai.url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
          sensio.io.bonsai.tier: Community
          sensio.io.bonsai.version: 4.0.0
      register: result

    - assert:
        that:
          - result is changed
          - not result.object.headers
          - not result.object.filters
          - result.object.sha512 == '0ce9d52b270b77f4cab754e55732ae002228201d0bd01a89b954a0655b88c1ee6546e2f82cfd1eec04689af90ad940cde128e8867912d9e415f4a58d7fdcdadf'
          - "'sensu.io.bonsai.tags' not in result.object.metadata.annotations"

    - name: Create a second asset
      asset:
        auth:
          url: http://localhost:8080
        name: asset2
        url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
        sha512: 518e7c17cf670393045bff4af318e1d35955bfde166e9ceec2b469109252f79043ed133241c4dc96501b6636a1ec5e008ea9ce055d1609865635d4f004d7187b
        filters:
          - "entity.system.os == 'linux'"
          - "entity.system.arch == 'amd64'"
          - "entity.system.platform == 'rhel'"
        annotations:
          sensio.io.bonsai.url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
          sensio.io.bonsai.tier: Community
          sensio.io.bonsai.version: 4.0.0
          sensio.io.bonsai.tags: ruby-runtime-2.4.4

    - name: Fetch a specific asset
      asset_info:
        auth:
          url: http://localhost:8080
        name: asset
      register: result

    - assert:
        that:
          - result.objects | length == 1
          - result.objects.0.metadata.name == 'asset'

    - name: Fetch all assets
      asset_info:
        auth:
          url: http://localhost:8080
      register: result

    - assert:
        that:
          - result.objects | length == 2
          - result.objects.0.metadata.name == 'asset'

    - name: Delete second asset
      asset:
        auth:
          url: http://localhost:8080
        name: asset2
        state: absent

    - name: Fetch all assets
      asset_info:
        auth:
          url: http://localhost:8080
      register: result

    - assert:
        that:
          - result.objects | length == 1
          - result.objects.0.metadata.name == 'asset'
